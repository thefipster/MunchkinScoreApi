trigger:
- master
- feature/*

pool:
  vmImage: 'ubuntu-18.04'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:

- task: NodeTool@0 
  inputs:
    versionSpec: '10.x'

- task: DotNetCoreCLI@2
  displayName: 'Build solution'
  inputs:
    command: build
    arguments: '--configuration $(buildConfiguration)'

- task: Npm@1
  displayName: 'Npm install'
  inputs:
    command: install
    workingDir: src/TheFipster.Munchkin.Spa

- script: sudo npm install -g @angular/cli
  workingDirectory: src/TheFipster.Munchkin.Spa
  displayName: 'Install angular cli'

- script: sudo ng build --outputPath $(Build.ArtifactStagingDirectory)/spa-client
  workingDirectory: src/TheFipster.Munchkin.Spa
  displayName: 'Build angular'

- task: DotNetCoreCLI@2
  displayName: 'Run tests'
  inputs:
    command: test
    projects: '**/*Tests/*.csproj'
    arguments: '--filter FullyQualifiedName~UnitTest --configuration $(buildConfiguration) --collect "Code coverage"'

- script: dotnet test --filter FullyQualifiedName~UnitTest --logger trx --collect "Code coverage"
  displayName: 'Collect test results'

- task: PublishTestResults@2
  displayName: 'Report test results'
  inputs:
    testRunner: VSTest
    testResultsFiles: '**/*.trx'

- task: DotNetCoreCLI@2
  displayName: 'Publish identity api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Identity.Api/TheFipster.Munchkin.Identity.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/identity-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish gaming api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Gaming.Api/TheFipster.Munchkin.Gaming.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/gaming-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish admin api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Admin.Api/TheFipster.Munchkin.Admin.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/admin-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish cardstash api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.CardStash.Api/TheFipster.Munchkin.CardStash.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/cardstash-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish statistics api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Statistics.Api/TheFipster.Munchkin.Statistics.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/statistics-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish sample api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Sample.Api/TheFipster.Munchkin.Sample.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/sample-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish monitoring api'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Monitoring.Api/TheFipster.Munchkin.Monitoring.Api.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/monitoring-api
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: DotNetCoreCLI@2
  displayName: 'Publish cli client'
  inputs:
    command: publish
    projects: src/TheFipster.Munchkin.Cli.Client/TheFipster.Munchkin.Cli.Client.csproj
    outputDir: $(Build.ArtifactStagingDirectory)/cli-client
    configuration: $(BuildConfiguration)
    zipAfterPublish: True

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'apps'
    publishLocation: 'Container'